# Copyright (c) IBM Corporation 2025
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

DOCUMENTATION = r"""
role: gather_diagnostics
short_description: Gathers diagnostic facts from z/OS managed nodes and the Ansible controller.
description:
    - >
      The B(gather_diagnostics) role gathers a comprehensive set of diagnostic facts
      from both the z/OS managed node and the Ansible controller node.
    - >
      B(Managed Node (z/OS):) Gathers ZOAU version, Python version, locale,
      environment variables, user limits, pip packages, z/OS system facts,
      OMVS segment, filesystem mount status, and ZOAU APF attributes.
    - >
      B(Controller Node:) Gathers Ansible version, SSH version, Ansible config,
      locale, installed collections, environment, and system facts.
    - >
      This role can create separate YAML report files for the z/OS node
      (C(gather_diagnostics_report_managed_node.yml)) and the controller node
      (C(gather_diagnostics_report_controller.yml)) in the user's home directory.
    - >
      Facts are also set on the respective hosts: C(gather_diagnostics_managed_results)
      on the z/OS host and C(gather_diagnostics_controller_results) on localhost.
author:
    - Rohitash Goyal (@Rohitcodes28)
options:
    controller_node:
        description:
            - >
              Controls whether the role will gather diagnostic facts from the
              Ansible controller node.
        required: False
        type: bool
        default: True
    controller_node_log_file:
        description:
            - >
              Controls whether the role creates a YAML report file for the
              controller node and hides sensitive data (C(no_log: true))
              from the console for controller tasks.
        required: False
        type: bool
        default: True
    gather_diagnostics_gather_syslog:
        description:
            - >
              If set to C(False), the role will not execute the
              MVS operator commands C(D A,L), C(D OMVS,LIMITS), and
              C(D OMVS,OPTIONS) on the z/OS managed node.
        required: False
        type: bool
        default: True
    managed_node_log_file:
        description:
            - >
              Controls whether the role creates a YAML report file for the
              z/OS managed node and hides sensitive data (C(no_log: true))
              from the console for z/OS tasks.
        required: False
        type: bool
        default: True
    gather_diagnostics_output_dir:
        description:
            - >
              Controls where the role creates a YAML report file for the
              z/OS managed node and controller to hide sensitive data (C(no_log: true))
              from the console.
        required: False
        type: str
"""

EXAMPLES = r"""
- name: Run gather_diagnostics to gather z/OS and controller node diagnostics (default)
  hosts: zos_host
  gather_facts: false
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: gather_diagnostics

- name: Run gather_diagnostics and print all sensitive data to console (no log file)
  hosts: zos_host
  gather_facts: false
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: gather_diagnostics
      vars:
        controller_node_log_file: false
        managed_node_log_file: false

- name: Run gather_diagnostics and not execute operator commands
  hosts: zos_host
  gather_facts: false
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: gather_diagnostics
      vars:
        gather_diagnostics_gather_syslog: false

- name: Run gather_diagnostics only for z/OS node diagnostics
  hosts: zos_host
  gather_facts: false
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: gather_diagnostics
      vars:
        controller_node: false

- name: Run gather_diagnostics only for controller node diagnostics
  hosts: zos_host
  gather_facts: false
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: gather_diagnostics
      vars:
        managed_node: false
"""

Note = r"""
1. If  C(environment- '{{ environment_vars }}')  is defined in the main playbook before controller execution,
the role will fail as the controller tasks will assume them as local environment variables,
when they are meant for the managed node running z/OS.
"""

# Roles don't return anything.
# But RETURN block must be defined for doc extraction tooling to avoid error.
# The content in RETURN block will not be display in doc-site.
RETURN = r"""
changed:
    description: Indicates if any change is made during the role operation.
    returned: always
    type: bool
gather_diagnostics_managed_results:
    description: >
        A fact set on the managed host containing all gathered diagnostic data.
        This data is also written to a YAML file on the controller if
        C(managed_node_log_file) is C(True).
    returned: always
    type: dict
    contains:
        zoau_version:
            description: The standard output of the `zoaversion -c` command.
            type: str
        zoau_version_stderr:
            description: The standard error of the `zoaversion -c` command.
            type: str
        python_version:
            description: The standard output from `python3 --version`.
            type: str
        python_version_stderr:
            description: The standard error from `python3 --version`.
            type: str
        locale:
            description: A list of locale settings from the `locale` command.
            type: list
        environment:
            description: A list of environment variables from the `env` command.
            type: list
        zos_facts:
            description: A dictionary of z/OS facts from `zos_gather_facts`.
            type: dict
        zos_facts_fallback:
            description: The output of the Python-based `zinfo` fallback query. Returned in case `zos_gather_facts` fails.
            type: list
        pip_list:
            description: A list of installed packages from `pip3 list`.
            type: list
        pip_show_zoau:
            description: The output of `pip3 show zoautil-py`.
            type: list
        pip_show_zoau_stderr:
            description: The standard error of `pip3 show zoautil-py`.
            type: str
        user_limits:
            description: A list of user limits from the `ulimit -a` command.
            type: list
        omvs_segment:
            description: The output of the `tsocmd "lu $(whoami) omvs"` command.
            type: list
        df_zoau_path:
            description: The mount status of the ZOAU home directory.
            type: list
        zoau_bin_attributes:
            description: The output of `ls -laE` on the ZOAU bin directory.
            type: list
        df_python_path:
            description: The mount status of the Python home directory.
            type: list
        operator_d_a_l:
            description: >
                The output of the MVS operator command `D A,L`,
                or 'N/A' if `gather_diagnostics_gather_syslog` is false.
            type: list
        operator_d_omvs_limits:
            description: >
                The output of the MVS operator command `D OMVS,LIMITS`,
                or 'N/A' if `gather_diagnostics_gather_syslog` is false.
            type: list
        operator_d_omvs_options:
            description: >
                The output of the MVS operator command `D OMVS,OPTIONS`,
                or 'N/A' if `gather_diagnostics_gather_syslog` is false.
            type: list

gather_diagnostics_controller_results:
    description: >
        A fact set on control node containing all controller
        diagnostic data. This data is also written to a YAML file on the
        controller if C(controller_node_log_file) is C(True).
    returned: when C(control_node) is C(True)
    type: dict
    contains:
        ansible_version:
            description: The output of the `ansible --version` command.
            type: str
        ssh_version:
            description: The output of the `ssh -V` command.
            type: str
        ansible_config_all:
            description: A list of all Ansible configuration settings.
            type: list
        ansible_config_changed:
            description: A list of changed Ansible configuration settings.
            type: list
        locale:
            description: A list of locale settings from the controller.
            type: list
        collections:
            description: A list of installed Ansible collections.
            type: list
        environment:
            description: A list of environment variables from the controller.
            type: list
        controller_facts:
            description: A dictionary of facts from the controller.
            type: dict
"""