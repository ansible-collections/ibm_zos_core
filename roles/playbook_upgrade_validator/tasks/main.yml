---
- name: Check if ruamel.yaml is already installed
  ansible.builtin.command: python3 -m pip show ruamel.yaml
  register: ruamel_check
  failed_when: false
  changed_when: false
  delegate_to: localhost

- name: Ensure ruamel.yaml is installed (for YAML parsing and playbook validation)
  ansible.builtin.pip:
    name: ruamel.yaml
    state: present
  when: ruamel_check.rc != 0
  register: ruamel_install
  delegate_to: localhost

- name: Check Python path
  ansible.builtin.command: which python3
  delegate_to: localhost
  register: python_path_result

- name: Load migration changes from JSON file
  set_fact:
    data: "{{ lookup('file', 'dependency_config.json') | from_json }}"
  delegate_to: localhost

- name: Run playbook upgrade validator to list migration changes
  ansible.builtin.command:
    cmd: >
      "{{ python_path_result.stdout }}" "{{ role_path }}/files/playbook_upgrade_validator.py"
      --playbook_path "{{ playbook_path }}"
      --output_path "{{ output_path }}"
      --ignore_response_params "{{ ignore_response_params }}"
      --migration_map '{{ data | to_json }}'
  register: result
  delegate_to: localhost

- name: Print path where validation results are stored
  debug:
    msg: "Results saved to file: {{ output_path }}"
  delegate_to: localhost

- name: Remove ruamel.yaml if installed by this role
  ansible.builtin.pip:
    name: ruamel.yaml
    state: absent
  when: ruamel_install is defined and ruamel_install.changed
  delegate_to: localhost