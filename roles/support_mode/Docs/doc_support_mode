# Copyright (c) IBM Corporation 2020, 2025
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

DOCUMENTATION = r"""
role: support_mode
short_description: Gathers diagnostic facts from a z/OS managed node.
description:
    - >
      The B(support_mode) role gathers a comprehensive set of diagnostic facts
      from a z/OS managed node.
    - >
      This includes information about the ZOAU installation, Python version,
      system locale, environment variables, user limits (ulimit),
      pip packages, z/OS system facts, OMVS segment, filesystem mount status,
      and APF attributes for ZOAU.
    - >
      If C(create_log_file) is C(True) (the default), all gathered information
      is consolidated and saved to a YAML report file
      C(support_mode_report_<hostname>.yml) in the user's home
      directory on the Ansible controller, and sensitive data is hidden
      from the console.
    - >
      If C(create_log_file) is C(False), no file is created, and all data
      is printed to the console.
    - >
      A fact named C(support_mode_managed_results) is also set on the
      managed host with the same data.
author:
    - Rohitash Goyal (@Rohitcodes28)
options:
    support_mode_gather_syslog:
        description:
            - >
              If set to C(True), the role will also attempt to run the
              MVS operator commands C(D A,L), C(D OMVS,LIMITS), and
              C(D OMVS,OPTIONS) to gather system activity and OMVS status.
        required: False
        type: bool
        default: False
    create_log_file:
        description:
            - >
              Controls whether the role creates a YAML report file on the controller
              and hides sensitive data from the console.
            - >
              If C(True), the report file is created and sensitive data
              is hidden from the console (C(no_log: true)).
            - >
              If C(False), no report file is created and all gathered data,
              including sensitive information, is printed to the console (C(no_log: false)).
        required: False
        type: bool
        default: True
"""

EXAMPLES = r"""
- name: Run support_mode to gather z/OS diagnostics (default)
  hosts: zos_host
  gather_facts: no
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: support_mode

- name: Run support_mode and include MVS operator command output
  hosts: zos_host
  gather_facts: no
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: support_mode
      vars:
        support_mode_gather_syslog: true

- name: Run support_mode and print all sensitive data to console (no log file)
  hosts: zos_host
  gather_facts: no
  collections:
    - ibm.ibm_zos_core
  tasks:
    - include_role:
        name: support_mode
      vars:
        create_log_file: false
"""

# Roles don't return anything.
# But RETURN block must be defined for doc extraction tooling to avoid error.
# The content in RETURN block will not be display in doc-site.
RETURN = r"""
changed:
    description: Indicates if any change is made during the role operation.
    returned: always
    type: bool
support_mode_managed_results:
    description: >
        A fact set on the managed host containing all gathered diagnostic data.
        This data is also written to a YAML file on the controller if
        C(create_log_file) is C(True).
    returned: always
    type: dict
    contains:
        zoau_version:
            description: The standard output of the `zoaversion -c` command.
            type: str
        zoau_version_stderr:
            description: The standard error of the `zoaversion -c` command.
            type: str
        python_version_stdout:
            description: The standard output from `python3 --version`.
            type: str
        python_version_stderr:
            description: The standard error from `python3 --version`.
            type: str
        locale:
            description: A list of locale settings from the `locale` command.
            type: list
        environment:
            description: A list of environment variables from the `env` command.
            type: list
        zos_facts:
            description: A dictionary of z/OS facts from `zos_gather_facts`.
            type: dict
        zos_facts_fallback:
            description: The output of the Python-based `zinfo` fallback query.
            type: list
        pip_list:
            description: A list of installed packages from `pip3 list`.
            type: list
        pip_show_zoau:
            description: The output of `pip3 show zoautil-py`.
            type: list
        pip_show_zoau_stderr:
            description: The standard error of `pip3 show zoautil-py`.
            type: str
        user_limits:
            description: A list of user limits from the `ulimit -a` command.
            type: list
        omvs_segment:
            description: The output of the `tsocmd "lu $(whoami) omvs"` command.
            type: list
        df_zoau_path:
            description: The mount status of the ZOAU home directory.
            type: list
        zoau_bin_attributes:
            description: The output of `ls -laE` on the ZOAU bin directory.
            type: list
        df_python_path:
            description: The mount status of the Python home directory.
            type: list
        operator_d_a_l:
            description: >
                The output of the MVS operator command `D A,L`,
                or 'N/A' if `support_mode_gather_syslog` is false.
            type: list
        operator_d_omvs_limits:
            description: >
                The output of the MVS operator command `D OMVS,LIMITS`,
                or 'N/A' if `support_mode_gather_syslog` is false.
            type: list
        operator_d_omvs_options:
            description: >
                The output of the MVS operator command `D OMVS,OPTIONS`,
                or 'N/A' if `support_mode_gather_syslog` is false.
            type: list
"""